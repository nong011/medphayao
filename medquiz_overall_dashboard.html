<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz - Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f7fafc; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 45vh; }
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: #4A90E2; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="dashboard-content" class="container mx-auto p-4 sm:p-6 lg:p-8 opacity-0">

        <header class="mb-10 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">MedQuiz Dashboard</h1>
            <p class="text-lg text-gray-600 mt-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö</p>
        </header>

        <main class="space-y-10">

            <section id="kpi-snapshot" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p id="kpi-total-users" class="text-5xl font-bold text-blue-600 text-right">-</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between border-l-4 border-green-500">
                    <h3 class="text-lg font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p id="kpi-total-exams" class="text-5xl font-bold text-green-600 text-right">-</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between border-l-4 border-yellow-500">
                    <h3 class="text-lg font-bold text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°</h3>
                    <p id="kpi-avg-score" class="text-5xl font-bold text-yellow-600 text-right">-%</p>
                </div>
            </section>
            
            <section id="leaderboard" class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-900">üèÜ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                <div id="leaderboard-list" class="space-y-2"></div>
            </section>

            <section id="category-popularity" class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="font-bold text-xl mb-4 text-center text-gray-900">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                <div class="chart-container">
                    <canvas id="categoryPopularityChart"></canvas>
                </div>
            </section>
            
            <section id="question-analysis" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-xl mb-4 text-center text-red-600">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                    <div id="hardest-questions-list" class="space-y-3"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-xl mb-4 text-center text-green-600">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                    <div id="easiest-questions-list" class="space-y-3"></div>
                </div>
            </section>

        </main>

        <footer class="text-center mt-12 text-gray-500">
            <p id="footer-text">MedQuiz Dashboard</p>
        </footer>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwX_ExQ5vVhMwrRhW2D9uWD0g4ffXfPGYkH65shrwp7Rxkk2RQ3xfl66x_SPnDgi4QKdQ/exec';

    const loadingOverlay = document.getElementById('loading-overlay');
    const dashboardContent = document.getElementById('dashboard-content');
    let popularityChart;

    const tooltipTitleCallback = (tooltipItems) => {
        const item = tooltipItems[0];
        let label = item.chart.data.labels[item.dataIndex];
        return Array.isArray(label) ? label.join(' ') : label;
    };
    
    const showError = (message) => {
        dashboardContent.innerHTML = `<div class="text-center p-8 text-red-500 bg-red-50 rounded-lg">
            <h1 class="text-2xl font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h1>
            <p>${message}</p>
        </div>`;
        loadingOverlay.style.opacity = '0';
        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
        dashboardContent.style.opacity = '1';
    };

    const renderDashboard = (data) => {
        document.getElementById('kpi-total-users').textContent = data.kpis.totalUsers;
        document.getElementById('kpi-total-exams').textContent = data.kpis.totalExams;
        document.getElementById('kpi-avg-score').textContent = `${data.kpis.averageScore}%`;

        const leaderboardList = document.getElementById('leaderboard-list');
        leaderboardList.innerHTML = '';
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        if(data.leaderboard && data.leaderboard.length > 0) {
            data.leaderboard.forEach((user, index) => {
                const rankText = medals[index] || `${index + 1}.`;
                const item = document.createElement('div');
                item.className = 'flex items-center p-2 rounded-md transition-colors hover:bg-gray-100';
                item.innerHTML = `
                    <span class="font-bold w-10 text-center text-lg">${rankText}</span>
                    <span class="flex-1 text-gray-800">${user.name}</span>
                    <span class="font-bold text-blue-600">${user.score.toFixed(1)}%</span>
                `;
                leaderboardList.appendChild(item);
            });
        } else {
            leaderboardList.innerHTML = `<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
        }

        if (popularityChart) popularityChart.destroy();
        const popularityCtx = document.getElementById('categoryPopularityChart').getContext('2d');
        popularityChart = new Chart(popularityCtx, {
            type: 'bar',
            data: {
                labels: data.categoryPopularity.map(c => c.name),
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö',
                    data: data.categoryPopularity.map(c => c.count),
                    backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
                    borderColor: 'rgba(255, 255, 255, 0.5)',
                    borderWidth: 1,
                    borderRadius: 5,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                plugins: { legend: { display: false }, tooltip: { callbacks: { title: tooltipTitleCallback } } }
            }
        });

        const renderQuestionList = (elementId, questions, colorClass) => {
            const listElement = document.getElementById(elementId);
            listElement.innerHTML = '';
            if (questions.length > 0) {
                questions.forEach(q => {
                    const item = document.createElement('div');
                    item.className = `p-3 border-l-4 ${colorClass} bg-gray-50 rounded-lg`;
                    item.innerHTML = `
                        <p class="font-semibold text-gray-700 truncate">${q.text}</p>
                        <p class="text-sm text-gray-500">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: <span class="font-bold">${q.correctRate.toFixed(1)}%</span> (‡∏à‡∏≤‡∏Å ${q.attempts} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</p>
                    `;
                    listElement.appendChild(item);
                });
            } else {
                listElement.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>`;
            }
        };
        renderQuestionList('hardest-questions-list', data.hardestQuestions, 'border-red-400');
        renderQuestionList('easiest-questions-list', data.easiestQuestions, 'border-green-400');
        
        const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('footer-text').textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${today}`;
    };

    async function loadDashboardData() {
        if (GAS_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
             showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GAS_WEB_APP_URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML ‡∏Å‡πà‡∏≠‡∏ô");
             return;
        }

        try {
            const response = await fetch(GAS_WEB_APP_URL);
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();

            if (data.status !== 'success' || data.dataType !== 'overall') {
                throw new Error(data.message || "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å Server");
            }
            
            renderDashboard(data);
            
            dashboardContent.classList.add('fade-in');
            dashboardContent.style.opacity = '1';

        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        } finally {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
        }
    }

    loadDashboardData();
});
</script>
</body>
</html>

