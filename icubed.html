<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ICU ‡∏£‡∏ß‡∏°</title>
    <!-- ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ó‡∏≥ Responsive --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ Inter ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô */
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
            background-color: #ffffff; 
        }
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Grid Layout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ */
        .patient-grid {
            display: grid;
            /* MOBILE (Default): ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
            grid-template-columns: repeat(2, minmax(0, 1fr)); 
            gap: 0.75rem; /* ‡∏•‡∏î gap ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
        }
        /* DESKTOP/TABLET: ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 640px ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ */
        @media (min-width: 640px) {
            .patient-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        .icon-img {
            width: 28px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
            height: 28px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
            object-fit: contain;
            font-size: 28px; 
            line-height: 1;
        }
        .gender-icon {
            width: 26px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏® */
            height: 26px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏® */
            margin-left: 6px; /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
            display: inline-block;
            vertical-align: middle;
            object-fit: contain;
        }

        /* UPDATED: Responsive Font Size ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Title */
        @media (max-width: 640px) { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .main-title {
                font-size: 1.5rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 24px */
            }
            .patient-card-title {
                font-size: 1.25rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î */
            }
            .logo-img {
                max-width: 90%;
            }
        }
        @media (min-width: 641px) { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ */
            .main-title {
                font-size: 2.25rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 36px */
            }
            .patient-card-title {
                font-size: 1.5rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î */
            }
        }

        /* Logo Container */
        .logo-container {
            display: flex;
            justify-content: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            margin-bottom: 1.5rem; 
            text-align: center;
        }

        /* Summary Card Styling */
        .summary-card {
            display: grid;
            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠, 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ */
            grid-template-columns: repeat(2, minmax(0, 1fr)); 
            gap: 0.5rem;
            background-color: #f7f9fc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        @media (min-width: 641px) {
            .summary-card {
                 grid-template-columns: repeat(4, minmax(0, 1fr)); 
            }
        }
        .summary-item {
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            line-height: 1.2;
            font-size: 0.875rem; /* text-sm */
        }
        .summary-value {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
        }
    </style>
</head>
<body class="p-3 md:p-6"> <!-- ‡∏•‡∏î Padding ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->

    <!-- Logo Header --><header class="text-center mb-6">
        <div class="logo-container">
            <img 
                src="https://phayaohospital.moph.go.th/assets/images/logonew.png" 
                alt="Logo ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•" 
                class="mx-auto w-full h-auto object-contain mb-2 logo-img"
                onerror="this.onerror=null; this.style.display='none';">
        </div>
    </header>

    <!-- REMOVED: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard ‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠) --><div id="loadingStatus" class="text-center mt-8 text-blue-600">
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>

    <!-- Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö All ICU Units -->
    <!-- Patient Cards ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ ICU Unit ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->
    <div id="dashboardContainer" class="max-w-6xl mx-auto">
    </div>

    <!-- Footer/Credit --><footer class="mt-12 border-t pt-4 text-center text-gray-500 text-sm max-w-6xl mx-auto">
        ¬© 2025 Designed by Krairat Komdee, MD.
    </footer>

    <script>
        // *** 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Sheets ***
        const SPREADSHEET_ID = '1kijAFC1_lT2jQdHcnjSRrmFOwXqbgdW0NSUVVAQxMVE';
        const SHEET_NAMES = ['ICU1', 'ICU2', 'ICU3', 'ICU4'];
        
        // ** URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å GitHub (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠) **
        const URL_HFNC = 'https://raw.githubusercontent.com/nong011/medphayao/17721c1534b3d86c2f1309533c92282ecf9b2d1f/HFNC.png';
        const URL_VENTILATOR = 'https://raw.githubusercontent.com/nong011/medphayao/main/ventilator.png';
        const URL_MALE = 'https://raw.githubusercontent.com/nong011/medphayao/bd98599455c7978a40936b5b6f8946b2c9994182/S__148930609.jpg';
        const URL_FEMALE = 'https://raw.githubusercontent.com/nong011/medphayao/main/female.png'; 
        // UPDATED: ‡πÉ‡∏ä‡πâ URL ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
        const URL_BED = 'https://raw.githubusercontent.com/nong011/medphayao/059a5355f2cf8bae40b608dbb182708b1d6870c8/bed.png'; 
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ ICU Unit (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á)
        const totalCapacity = 10; 

        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary Card HTML
         * @param {object} stats ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ICU Unit (totalPatients, ventilatorCount, hfncCount)
         * @returns {string} HTML string ‡∏Ç‡∏≠‡∏á Summary Card
         */
        function createSummaryCard(stats) {
            const occupied = stats.totalPatients;
            const empty = stats.totalCapacity - occupied;
            const ventilator = stats.ventilatorCount;
            const hfnc = stats.hfncCount;

            // ‡πÉ‡∏ä‡πâ NumberFormat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
            const formatNumber = (num) => isNaN(num) ? '?' : new Intl.NumberFormat('th-TH').format(num);

            return `
                <div class="summary-card mb-4 mt-2">
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏° -->
                    <div class="summary-item bg-blue-100 text-blue-800">
                        <div class="summary-value">${formatNumber(occupied)}</div>
                        <div>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</div>
                    </div>
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á -->
                    <div class="summary-item bg-green-100 text-green-800">
                        <div class="summary-value">${formatNumber(empty)}</div>
                        <div>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
                    </div>
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ Ventilator -->
                    <div class="summary-item bg-red-100 text-red-800">
                        <div class="summary-value">${formatNumber(ventilator)}</div>
                        <div>Ventilator</div>
                    </div>
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ HFNC -->
                    <div class="summary-item bg-amber-100 text-amber-800">
                        <div class="summary-value">${formatNumber(hfnc)}</div>
                        <div>HFNC</div>
                    </div>
                </div>
            `;
        }

        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á Patient Card HTML
         * @param {object} data ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
         * @returns {string} HTML string ‡∏Ç‡∏≠‡∏á Patient Card
         */
        function createPatientCard(data) {
            // --- 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Oxygen ‡πÅ‡∏•‡∏∞‡∏™‡∏µ ---
            const oxygenStatus = data.Oxygen ? data.Oxygen.toUpperCase().trim() : '';
            let borderColor = 'border-gray-300'; // Default gray
            let bgColor = 'bg-white';
            
            // ‡πÉ‡∏ä‡πâ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å GitHub, ‡∏û‡∏£‡πâ‡∏≠‡∏° onerror fallback
            let statusIconElement = `<img src="${URL_BED}" class="icon-img" alt="Bed Icon" onerror="this.onerror=null; this.outerHTML='<span class=\\'text-xl\\'>üõèÔ∏è</span>';">`; 

            if (oxygenStatus.includes('VENTILA')) {
                borderColor = 'border-red-500 ring-4 ring-red-200'; // ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏à
                bgColor = 'bg-red-50';
                statusIconElement = `<img src="${URL_VENTILATOR}" class="icon-img" alt="Ventilator Icon" onerror="this.onerror=null; this.outerHTML='<span class=\\'text-xl\\'>üö®</span>';">`;
            } else if (oxygenStatus.includes('HIGH')) {
                borderColor = 'border-amber-500 ring-4 ring-amber-200'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö High Flow
                bgColor = 'bg-amber-50';
                statusIconElement = `<img src="${URL_HFNC}" class="icon-img" alt="HFNC Icon" onerror="this.onerror=null; this.outerHTML='<span class=\\'text-xl\\'>‚ö†Ô∏è</span>';">`;
            } 
            
            // --- 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏® ---
            let genderIconElement = '';
            if (data.Sex) {
                const sex = data.Sex.toUpperCase().trim();
                if (sex === 'F') {
                    genderIconElement = `<img src="${URL_FEMALE}" class="gender-icon" alt="Female Icon" onerror="this.onerror=null; this.outerHTML='<span class=\\'gender-icon\\'>üö∫</span>';">`;
                } else if (sex === 'M') {
                    genderIconElement = `<img src="${URL_MALE}" class="gender-icon" alt="Male Icon" onerror="this.onerror=null; this.outerHTML='<span class=\\'gender-icon\\'>üöπ</span>';">`;
                }
            }


            return `
                <div class="patient-card ${bgColor} border-l-8 ${borderColor} p-3 rounded-xl shadow-md transition transform hover:scale-[1.02] hover:shadow-lg cursor-pointer">
                    <div class="flex justify-between items-center mb-2"> 
                        <h3 class="patient-card-title font-extrabold text-gray-900 leading-none flex items-center">
                            ${data.Bed || '-'} ${genderIconElement} 
                        </h3>
                        <div class="flex-shrink-0 w-7 h-7 flex items-center justify-center">${statusIconElement}</div> 
                    </div>
                    <div class="space-y-1 text-xs"> 
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-600">HN:</span>
                            <span class="font-medium text-gray-800">${data.HN || '-'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-600">AN:</span>
                            <span class="font-medium text-gray-800">${data.AN || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * ‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sheet ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
         * @param {string} sheetName ‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
         * @returns {Promise<{sheetName: string, data: object[], stats: object}>} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
         */
        async function fetchSheetData(sheetName) {
            const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
            const maxRetries = 3;
            let responseText;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (response.ok) {
                    responseText = await response.text();
                    break;
                }

                if (attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw new Error(`HTTP error! status: ${response.status} for sheet ${sheetName}`);
                }
            }
            
            // --- 2. ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSONP ‡πÄ‡∏õ‡πá‡∏ô JSON Object ---
            const jsonTextStart = responseText.indexOf('(') + 1;
            const jsonTextEnd = responseText.lastIndexOf(')');
            
            if (jsonTextStart === -1 || jsonTextEnd === -1 || jsonTextEnd <= jsonTextStart) {
                throw new Error(`Invalid JSONP format for sheet ${sheetName}`);
            }
            
            const jsonText = responseText.substring(jsonTextStart, jsonTextEnd);
            const data = JSON.parse(jsonText);
            
            const table = data.table;
            if (!table || !table.rows || table.rows.length === 0 || !table.cols || table.cols.length === 0) {
                 // Return empty data if sheet is valid but has no patient rows
                 return { sheetName, data: [], stats: { totalPatients: 0, ventilatorCount: 0, hfncCount: 0, totalCapacity: totalCapacity }, error: null }; 
            }

            const headers = table.cols.map(col => col.label.trim());
            
            const headerMap = {};
            const requiredHeaders = ['Bed', 'HN', 'AN', 'Sex', 'Oxygen']; 
            requiredHeaders.forEach(key => {
                headerMap[key] = headers.findIndex(h => h.toUpperCase() === key.toUpperCase());
            });

            if (headerMap.Bed === -1) {
                throw new Error(`Column 'Bed' not found in sheet ${sheetName}`);
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Patient Data Array
            let ventilatorCount = 0;
            let hfncCount = 0;

            const patientData = table.rows.map(row => {
                if (!row.c) return null; 

                const patient = {};
                const getValue = (index) => {
                    const cell = row.c[index];
                    if (cell && cell.v !== undefined) {
                        return (cell.f !== undefined) ? String(cell.f).trim() : String(cell.v).trim();
                    }
                    return null;
                };

                patient.Bed = getValue(headerMap.Bed);
                patient.HN = getValue(headerMap.HN);
                patient.AN = getValue(headerMap.AN);
                patient.Sex = getValue(headerMap.Sex);
                patient.Oxygen = getValue(headerMap.Oxygen);
                
                // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Summary Card
                if (patient.Oxygen) {
                    const status = patient.Oxygen.toUpperCase();
                    if (status.includes('VENTILA')) {
                        ventilatorCount++;
                    } else if (status.includes('HIGH')) {
                        hfncCount++;
                    }
                }
                
                return patient;
            }).filter(p => p && p.Bed && p.Bed.trim() !== ''); // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Bed
            
            const stats = {
                totalPatients: patientData.length,
                ventilatorCount: ventilatorCount,
                hfncCount: hfncCount,
                totalCapacity: totalCapacity // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ
            };

            return { sheetName, data: patientData, stats, error: null };
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å ICU
        async function loadAndDisplayData() {
            const statusElement = document.getElementById('loadingStatus');
            const containerElement = document.getElementById('dashboardContainer');
            statusElement.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>';
            containerElement.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡πà‡∏≤

            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Promise ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å Sheet ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const fetchPromises = SHEET_NAMES.map(sheetName => fetchSheetData(sheetName).catch(error => {
                    console.error(`Error fetching data for ${sheetName}:`, error);
                    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sheet ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
                    return { sheetName, data: [], stats: { totalPatients: 0, ventilatorCount: 0, hfncCount: 0, totalCapacity: totalCapacity }, error: error.message }; 
                }));
                
                const results = await Promise.all(fetchPromises);
                
                
                results.forEach(result => {
                    const sheetName = result.sheetName;
                    const patientData = result.data;
                    const error = result.error;
                    const stats = result.stats; // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Section ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ICU Unit ‡∏ô‡∏µ‡πâ
                    const unitSection = document.createElement('div');
                    unitSection.className = 'mb-8'; // ‡∏•‡∏î mb-10 ‡πÄ‡∏õ‡πá‡∏ô mb-8

                    let contentHtml = '';
                    
                    // --- 1. ‡πÅ‡∏™‡∏î‡∏á Summary Card ---
                    if (!error) {
                        contentHtml += createSummaryCard(stats);
                    }
                    
                    // --- 2. ‡πÅ‡∏™‡∏î‡∏á Patient Cards ‡∏´‡∏£‡∏∑‡∏≠ Error Message ---
                    if (error) {
                         // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ICU Unit ‡∏ô‡∏µ‡πâ
                         contentHtml += `
                            <div class="p-4 rounded-lg bg-red-50 border border-red-300 text-red-600 mt-4">
                                <p class="font-bold">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${sheetName} ‡πÑ‡∏î‡πâ</p>
                                <p class="text-sm">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.includes('HTTP error!') ? '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏™‡∏π‡πà‡πÄ‡∏ß‡πá‡∏ö)' : error}</p>
                            </div>`;
                    } else if (patientData.length > 0) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid Container ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Section
                        const cardsHtml = patientData.map(createPatientCard).join('');
                        contentHtml += `<div class="patient-grid mt-4">${cardsHtml}</div>`;
                    } else if (!error && stats.totalCapacity > 0) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                         contentHtml += `<p class="text-gray-500 mt-4 p-4 rounded-lg bg-gray-50">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô ${sheetName} (‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</p>`;
                    } else {
                         contentHtml += `<p class="text-gray-500 mt-4 p-4 rounded-lg bg-gray-50">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô ${sheetName}</p>`;
                    }

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡πÉ‡∏ô Section
                    unitSection.innerHTML = `
                        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-1 mb-4">
                            ${sheetName}
                        </h2>
                        ${contentHtml}`;
                    
                    containerElement.appendChild(unitSection);
                });

                // ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
                if (containerElement.innerHTML !== '') {
                    statusElement.innerHTML = '';
                } else {
                    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ (‡∏ó‡∏∏‡∏Å Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß/‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
                     statusElement.innerHTML = `
                        <div class="p-4 rounded-lg bg-red-100 border border-red-400 text-red-700 max-w-lg mx-auto">
                            <p class="font-bold">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ICU1, ICU2, ICU3, ‡πÅ‡∏•‡∏∞ ICU4 ‡πÄ‡∏•‡∏¢</p>
                            <p class="mt-2 text-sm">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô "‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏™‡∏π‡πà‡πÄ‡∏ß‡πá‡∏ö" ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    `;
                }


            } catch (error) {
                // ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Promise.all
                console.error("Critical Orchestration Error:", error.message, error);
                containerElement.innerHTML = ''; 
                statusElement.innerHTML = `
                    <div class="p-4 rounded-lg bg-red-100 border border-red-400 text-red-700 max-w-lg mx-auto">
                        <p class="font-bold">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <p class="mt-2 text-sm">‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏π Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                    </div>
                `;
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        window.onload = loadAndDisplayData;
        
    </script>

</body>
</html>
